<!DOCTYPE html>
<html lang="en-us">
<head>

  <meta charset="utf-8" />

  
  <title>Aggregating application deployment data (Part 1)</title>

  
  





  
  <meta name="author" content="Scott Guymer" />
  <meta name="description" content="Any company of a decent size and age that creates software at any scale will have gone through a number of &amp;ldquo;technical evolutions&amp;rdquo;. These come along as you hire new people, create new products or just better ways of doing things come along. The kind of changes I&amp;rsquo;m talking about are the adoption of different technologies over time and the introduction of new ones. This cuts right across different aspects of software, from languages to frameworks to techniques to tooling." />

  
  
    <meta name="twitter:card" content="summary" />
    <meta name="twitter:site" content="@mr_scottguymer" />
    <meta name="twitter:title" content="Aggregating application deployment data (Part 1)" />
    <meta name="twitter:description" content="Any company of a decent size and age that creates software at any scale will have gone through a number of &amp;ldquo;technical evolutions&amp;rdquo;. These come along as you hire new people, create new products or just better ways of doing things come along. The kind of changes I&amp;rsquo;m talking about are the adoption of different technologies over time and the introduction of new ones. This cuts right across different aspects of software, from languages to frameworks to techniques to tooling." />
    <meta name="twitter:image" content="https://www.scottguymer.co.uk/img/avatar.jpg" />
  

  
  <meta property="og:type" content="article" />
  <meta property="og:title" content="Aggregating application deployment data (Part 1)" />
  <meta property="og:description" content="Any company of a decent size and age that creates software at any scale will have gone through a number of &amp;ldquo;technical evolutions&amp;rdquo;. These come along as you hire new people, create new products or just better ways of doing things come along. The kind of changes I&amp;rsquo;m talking about are the adoption of different technologies over time and the introduction of new ones. This cuts right across different aspects of software, from languages to frameworks to techniques to tooling." />
  <meta property="og:url" content="https://www.scottguymer.co.uk/blog/aggregating-application-deployment-data/" />
  <meta property="og:image" content="https://www.scottguymer.co.uk/img/avatar.jpg" />




<meta name="generator" content="Hugo 0.31.1" />


<link rel="canonical" href="https://www.scottguymer.co.uk/blog/aggregating-application-deployment-data/" />
<link rel="alternative" href="https://www.scottguymer.co.uk/index.xml" title="Scott Guymer" type="application/atom+xml" />


<meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<meta name="format-detection" content="telephone=no,email=no,adress=no" />
<meta http-equiv="Cache-Control" content="no-transform" />


<meta name="robots" content="index,follow" />
<meta name="referrer" content="origin-when-cross-origin" />
<meta name="google-site-verification" content="Rop88G3o4ZxIlfG_B3VHOKboh8LM_UpKZTB1d1CTbIE" />






<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
<meta name="apple-mobile-web-app-title" content="Scott Guymer" />
<meta name="msapplication-tooltip" content="Scott Guymer" />
<meta name='msapplication-navbutton-color' content="#5fbf5e" />
<meta name="msapplication-TileColor" content="#5fbf5e" />
<meta name="msapplication-TileImage" content="/img/tile-image-windows.png" />
<link rel="icon" href="https://www.scottguymer.co.uk/img/favicon.ico" />
<link rel="icon" type="image/png" sizes="16x16" href="https://www.scottguymer.co.uk/img/favicon-16x16.png" />
<link rel="icon" type="image/png" sizes="32x32" href="https://www.scottguymer.co.uk/img/favicon-32x32.png" />
<link rel="icon" sizes="192x192" href="https://www.scottguymer.co.uk/img/touch-icon-android.png" />
<link rel="apple-touch-icon" href="https://www.scottguymer.co.uk/img/touch-icon-apple.png" />
<link rel="mask-icon" href="https://www.scottguymer.co.uk/img/safari-pinned-tab.svg" color="#5fbf5e" />



<link rel="stylesheet" href="//cdn.bootcss.com/video.js/6.2.8/alt/video-js-cdn.min.css" />

<link rel="stylesheet" href="https://www.scottguymer.co.uk/css/bundle.css" />


  
  <!--[if lt IE 9]>
    <script src="//cdn.bootcss.com/html5shiv/3.7.3/html5shiv.min.js"></script>
    <script src="//cdn.bootcss.com/respond.js/1.4.2/respond.min.js"></script>
    <script src="//cdn.bootcss.com/video.js/6.2.8/ie8/videojs-ie8.min.js"></script>
  <![endif]-->

<!--[if lte IE 11]>
    <script src="//cdn.bootcss.com/classlist/1.1.20170427/classList.min.js"></script>
  <![endif]-->


<script src="//cdn.bootcss.com/object-fit-images/3.2.3/ofi.min.js"></script>


<script src="//cdn.bootcss.com/smooth-scroll/12.1.4/js/smooth-scroll.polyfills.min.js"></script>


</head>
  <body>
    
    <div class="suspension">
      <a title="Go to top" class="to-top is-hide"><span class="icon icon-up"></span></a>
      
        
        <a title="Go to comments" class="to-comment" href="#disqus_thread"><span class="icon icon-comment"></span></a>
        
      
    </div>
    
    
  <header class="site-header">
  <img class="avatar" src="https://www.scottguymer.co.uk/images/main/scottguymer.jpg" alt="Avatar">
  
  <h2 class="title">Scott Guymer</h2>
  
  <p class="subtitle">~ Software Engineer ~</p>
  <button class="menu-toggle" type="button">
    <span class="icon icon-menu"></span>
  </button>
  <nav class="site-menu collapsed">
    <h2 class="offscreen">Main Menu</h2>
    <ul class="menu-list">
      
      
      
      
        <li class="menu-item
            
            
            
              is-active
            ">
            <a href="https://www.scottguymer.co.uk/">Home</a>
          </li>
      
        <li class="menu-item
            
            
            ">
            <a href="https://www.scottguymer.co.uk/tags/">Tags</a>
          </li>
      
        <li class="menu-item
            
            
            ">
            <a href="https://www.scottguymer.co.uk/about/">About</a>
          </li>
      
    </ul>
  </nav>
  <nav class="social-menu collapsed">
    <h2 class="offscreen">Social Networks</h2>
    <ul class="social-list">

      
      <li class="social-item">
        <a href="mailto:blog@scottguymer.co.uk" title="Email"><span class="icon icon-email"></span></a>
      </li>

      
      <li class="social-item">
        <a href="//github.com/scottguymer" title="GitHub"><span class="icon icon-github"></span></a>
      </li>

      <li class="social-item">
        <a href="//twitter.com/mr_scottguymer" title="Twitter"><span class="icon icon-twitter"></span></a>
      </li>

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      <li class="social-item">
        <a href="//www.linkedin.com/in/scottguymer" title="Linkedin"><span class="icon icon-linkedin"></span></a>
      </li>

      

      

      

      <li class="social-item">
        <a href="https://www.scottguymer.co.uk/index.xml"><span class="icon icon-rss" title="RSS"></span></a>
      </li>

    </ul>
  </nav>
</header>

  <section class="main post-detail">
    <header class="post-header">
      <h1 class="post-title">Aggregating application deployment data (Part 1)</h1>
      <p class="post-meta">@Scott Guymer · Mar 24, 2018 · 8 min read</p>
    </header>
    <article class="post-content">

<p>Any company of a decent size and age that creates software at any scale will have gone through a number of &ldquo;technical evolutions&rdquo;. These come along as you hire new people, create new products or just better ways of doing things come along. The kind of changes I&rsquo;m talking about are the adoption of different technologies over time and the introduction of new ones. This cuts right across different aspects of software, from languages to frameworks to techniques to tooling. We end up collecting an number of each for various reasons. It may even be a conscious choice where we see that one technology is better suited to solving a particular problem than another or one system is simply not as important and don&rsquo;t need the same investment. The reasons here aren&rsquo;t too important, the fact is you are in this situation and will be for a foreseeable amount of time.</p>

<p>When it comes to deployment software there are often lots of changes that have happened over time and more than likely more than one tool that is currently in use across your teams.</p>

<p>I know within the org I work in we have about 4 (that i know of!)</p>

<ul>
<li>Jenkins</li>
<li>GitLab Pipelines</li>
<li>Heroku Pipelines</li>
<li>Octopus Deploy</li>
</ul>

<p>The issue we have is that we have no insight across the teams into what is deploy, to where, when and how. There is very little reporting built into these tools to see across all of your applications and even if there were you would have to switch between applications to see any of this and implementations would likely differ wildly.</p>

<p>What we wanted to do was to bring all of this information together into one place so that we can have some sort of visibility and enable some level of insight into the applications that are being deployed across teams.</p>

<h2 id="web-hooks">Web-hooks</h2>

<p>Web-hooks are the key to this. Most of these applications support web-hooks right out of the box. Even those that don&rsquo;t we can provide a pretty simple curl script to inset into any shell script that is run as part of the deployment. Not as nice but it gets the job done.</p>

<p>So we are going to use web-hooks. Great. We need some sort of HTTP endpoint somewhere. And I don&rsquo;t want to be writing and managing a whole bunch of code to do all this, I especially don&rsquo;t want to be managing any infrastructure. I also have the issue that some of these systems are on-prem and some are cloud hosted SaaS products. You may think &ldquo;cloud functions!&rdquo; and I would agree that solves the infrastructure problem. But I still have to write, test and deploy some code (another deployment to track!).</p>

<p>Azure Logic Apps to the rescue, these are really simple drag and drop style connector apps that are perfect for simple things like this, think of <a href="https://ifttt.com/" title="ifttt">ifttt</a> or <a href="https://zapier.com" title="zapier">zapier</a> on crack. We can have a HTTP trigger to receive JSON data and dump it into a document store for later processing. Think of them as a layer over cloud functions that writes the code for you. They are pretty simple and provide a range of out of the box triggers and  connectors, including HTTP and Cosmos DB. So great, we can take in the web-hook data and store it into a document store.</p>

<p>In fact they are so simple in this case that there are only 2 steps</p>

<p><img src="https://www.scottguymer.co.uk/uploads/2018/03/24/logic_app.png" alt="" /></p>

<p>We can use the first request (or any sample data) to generate a JSON schema to help who the shape of the data. (This comes in handy with the Heroku issues later)</p>

<p>The one gotcha here is to make sure that you add in your own id that is generated at the point of the insert, and then nest your data inside there somewhere. Don&rsquo;t rely on the id data that may come in from the web-hook. It may be a static id for an app or deployment run in which case your data will be overwritten as new event come in for that app or deployment (start, finish, error etc)</p>

<p>At the moment I am dumping all of my data for each hook into different table. Im purposefully not doing any processing or transformation here. I want all the data for using later.</p>

<p>I rinse and repeat this for each of the different data sources. Creating a new, cosmos db collection and logic app for each data source.</p>

<h2 id="issues">Issues</h2>

<p>As you can imagine there is no way that these different systems were going to be sending me any standard format of data. Not even a little bit..</p>

<h3 id="octopus">Octopus</h3>

<p>The data coming out of the Octopus subscription is fairly good as you might expect from a deployment specific tool. The biggest problem is that it is all referential. It sends down IDs for projects and environments rather than their names. Which is a little bit of a pain. There are APIs that can be queried to get further information on each of these referenced resources. However, the octopus server sits internally and isn&rsquo;t accessible from Azure. To get around this i have simply manually dumped out the JSON for both the environment and projects and uploaded them to a Sharepoint site that is accessible by Power BI. I was then able to pull this into a data set, flatten it and link it to the deployment data to get application and environment names rather than just ids. I guess if it becomes a pain I could look at automating this in the future.</p>

<h3 id="heroku">Heroku</h3>

<p>Within Heroku each app is tied to a pipeline which has a stage. There is the notion of coupling an app to a pipeline and stage. However none of this information comes over within the release web-hook which is focussed primarily on apps and not pipelines. And at present there doesn&rsquo;t seem to be any web-hooks associated to pipeline actions specifically. So we would have to query the specific pipeline couplings for an app after we receive the web-hook from the app deployment. Thankfully there is a pipelines API that allows us to query the pipeline couplings from the appId</p>

<p><a href="https://devcenter.heroku.com/articles/platform-api-reference#pipeline-coupling-info-by-app" title="query the pipeline couplings from the appId ">https://devcenter.heroku.com/articles/platform-api-reference#pipeline-coupling-info-by-app</a></p>

<p>This looks something like this, with the addition of an Auth header.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ curl -n https://api.heroku.com/apps/$APP_ID_OR_NAME/pipeline-couplings <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>	-H <span style="color:#e6db74">&#34;Accept: application/vnd.heroku+json; version=3&#34;</span></code></pre></div>
<p>This returns the details of the coupling of the pipeline to the app like this</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json">{
	<span style="color:#f92672">&#34;app&#34;</span>: {
		<span style="color:#f92672">&#34;id&#34;</span>: <span style="color:#e6db74">&#34;01234567-89ab-cdef-0123-456789abcdef&#34;</span>
	},
 	<span style="color:#f92672">&#34;created_at&#34;</span>: <span style="color:#e6db74">&#34;2012-01-01T12:00:00Z&#34;</span>,
 	<span style="color:#f92672">&#34;id&#34;</span>: <span style="color:#e6db74">&#34;01234567-89ab-cdef-0123-456789abcdef&#34;</span>,
 	<span style="color:#f92672">&#34;pipeline&#34;</span>: {
  		<span style="color:#f92672">&#34;id&#34;</span>: <span style="color:#e6db74">&#34;01234567-89ab-cdef-0123-456789abcdef&#34;</span>
    },
 	<span style="color:#f92672">&#34;stage&#34;</span>: <span style="color:#e6db74">&#34;production&#34;</span>,
 	<span style="color:#f92672">&#34;updated_at&#34;</span>: <span style="color:#e6db74">&#34;2012-01-01T12:00:00Z&#34;</span>
}</code></pre></div>
<p>This gives is the stage which will be our environment data.</p>

<p>To do this we are able to insert another HTTP request into the logic app. It will make a request to the Heroku API using the app id received in the web-hook to get the pipeline information and attach it to each record when inserting into the db. This way we now have the application data and the pipeline that it is attached to. This logic app now has 3 steps but it was super simple to achieve this and is sill very easy to understand whats going on. The HTTP trigger is omitted from this picture is identical but we have added in another HTTP request step before saving to the DB. We have used the JSON schema to pull out the appid from the incoming JSON and pushed that in as a part of the HTTP request. We then append the body of the response to the document we insert, alongside the web-hook data.</p>

<p><img src="https://www.scottguymer.co.uk/uploads/2018/03/24/heroku_logic_app.png" alt="" /></p>

<h3 id="gitlab">GitLab</h3>

<p>There seem to be a few more issues with the data that comes back from GitLab. Firstly there is no notion of an environment in the pipelines web-hook data. So its a little tricky to figure out what has been deployed and where. Through the teams that use it within our org there seems to be some loose naming conventions for pipeline stages that has allowed me to pull the data apart in processing and gain some insight into what has been deployed and where. The deploy stage is helpfully called <code>deploy</code> and each job is named using the basic schema of <code>deploy:environment</code> and although all the jobs show up in the data only the one that has actually been deployed will be marked as succeeded.</p>

<p>Something like this</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json">{
   <span style="color:#f92672">&#34;id&#34;</span>: <span style="color:#ae81ff">467840</span>,
   <span style="color:#f92672">&#34;stage&#34;</span>: <span style="color:#e6db74">&#34;deploy&#34;</span>,
   <span style="color:#f92672">&#34;name&#34;</span>: <span style="color:#e6db74">&#34;deploy:uat&#34;</span>,
   <span style="color:#f92672">&#34;status&#34;</span>: <span style="color:#e6db74">&#34;success&#34;</span>,
   <span style="color:#f92672">&#34;created_at&#34;</span>: <span style="color:#e6db74">&#34;2018-03-24 09:50:30 UTC&#34;</span>,
   <span style="color:#f92672">&#34;started_at&#34;</span>: <span style="color:#e6db74">&#34;2018-03-24 09:54:05 UTC&#34;</span>,
   <span style="color:#f92672">&#34;finished_at&#34;</span>: <span style="color:#e6db74">&#34;2018-03-24 09:58:01 UTC&#34;</span>,
 <span style="color:#960050;background-color:#1e0010">...</span></code></pre></div>
<p>I am able to transform this data later when processing it. So i can get the data that i need but it isn&rsquo;t perfect.</p>

<h2 id="rationalising-the-data">Rationalising the data</h2>

<p>From the data collected above I spent some time thinking about what data was strictly needed to do some basic reporting and insight.</p>

<ul>
<li>Date</li>
<li>Some unique ID</li>
<li>Environment</li>
<li>Status</li>
<li>System</li>
</ul>

<p>I then used Power BI pull in the data and transform and shape it into the structure above to end up with one stream of data that could be used to visualise. I will go into what i did within Power BI in part 2 of this post.</p>

<h2 id="future-nice-to-haves">Future nice to haves</h2>

<p>Throughout doing this i have been thinking about how this data may be used to provide insight into the development and deployment process within teams.</p>

<ul>
<li>Deployment length - to help identify long and problematic deploys</li>
<li>Explicit commit sha to track back to source code</li>
<li>User that triggered the deploy</li>
</ul>
</article>
    <footer class="post-footer">
      
      <ul class="post-tags">
        
          <li><a href="https://www.scottguymer.co.uk/tags/deployment"><span class="tag">Deployment</span></a></li>
        
      </ul>
      
      <p class="post-copyright">
        © This post is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License，please give source if you wish to quote or reproduce.
      </p>
    </footer>
    
      <div id="disqus_thread"></div>
<script>
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "scottguymer" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
      
    
  </section>
  <footer class="site-footer">
  <p>© 2017-2018 Scott Guymer</p>
  <p>Powered by <a href="https://gohugo.io/" target="_blank">Hugo</a> with theme <a href="https://github.com/laozhu/hugo-nuo" target="_blank">Nuo</a>.</p>
  
</footer>



<script async src="//cdn.bootcss.com/video.js/6.2.8/alt/video.novtt.min.js"></script>
<script async src="//cdn.bootcss.com/mathjax/2.7.2/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [['$','$'], ['\\(','\\)']],
      displayMath: [['$$','$$'], ['\\[','\\]']],
      processEscapes: true,
      processEnvironments: true,
      skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
      TeX: { equationNumbers: { autoNumber: "AMS" },
      extensions: ["AMSmath.js", "AMSsymbols.js"] }
    }
  });
</script>
<script type="text/x-mathjax-config">
  // Fix <code> tags after MathJax finishes running. This is a
  // hack to overcome a shortcoming of Markdown. Discussion at
  // https://github.com/mojombo/jekyll/issues/199
  MathJax.Hub.Queue(() => {
    MathJax.Hub.getAllJax().map(v => v.SourceElement().parentNode.className += ' has-jax');
  });
</script>

<script src="https://www.scottguymer.co.uk/js/bundle.js"></script>


<script>
window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
ga('create', 'UA-113812052-1', 'auto');
ga('send', 'pageview');
</script>
<script async src='//www.google-analytics.com/analytics.js'></script>





  </body>
</html>
