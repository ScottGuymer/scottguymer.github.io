<!doctype html><html lang=en-us><head><meta charset=utf-8><title>BlackDuck Docker image scanning from within a docker container</title><link href=//cdn.jsdelivr.net rel=dns-prefetch><link href=//cdnjs.cloudflare.com rel=dns-prefetch><link href=//at.alicdn.com rel=dns-prefetch><link href=//fonts.googleapis.com rel=dns-prefetch><link href=//fonts.gstatic.com rel=dns-prefetch><link href=///disqus.com rel=dns-prefetch><link href=//c.disquscdn.com rel=dns-prefetch><link href=//www.google-analytics.com rel=dns-prefetch><meta name=description content="Docker is a great tool for build pipelines, without a doubt it allows you to create isolated and reproducible builds. Not just of docker images themselves, but also for artifacts that you might extract and use outside of the container.
When you are building Docker images security should be one of the concerns you can take care of in your CI piplien. This varies from simple linting of your dockerfiles using something like hadolint to a more complex scanner that can scan the internals of your images and give you some clues as to where you might need to address security concerns."><meta name=twitter:card content="summary"><meta name=twitter:site content="@mr_scottguymer"><meta name=twitter:title content="BlackDuck Docker image scanning from within a docker container"><meta name=twitter:description content="Docker is a great tool for build pipelines, without a doubt it allows you to create isolated and reproducible builds. Not just of docker images themselves, but also for artifacts that you might extract and use outside of the container.
When you are building Docker images security should be one of the concerns you can take care of in your CI piplien. This varies from simple linting of your dockerfiles using something like hadolint to a more complex scanner that can scan the internals of your images and give you some clues as to where you might need to address security concerns."><meta name=twitter:image content="/images/scottguymer.jpg"><meta property="og:type" content="article"><meta property="og:title" content="BlackDuck Docker image scanning from within a docker container"><meta property="og:description" content="Docker is a great tool for build pipelines, without a doubt it allows you to create isolated and reproducible builds. Not just of docker images themselves, but also for artifacts that you might extract and use outside of the container.
When you are building Docker images security should be one of the concerns you can take care of in your CI piplien. This varies from simple linting of your dockerfiles using something like hadolint to a more complex scanner that can scan the internals of your images and give you some clues as to where you might need to address security concerns."><meta property="og:url" content="https://www.scottguymer.co.uk/post/blackduck-scanning-in-docker/"><meta property="og:image" content="/images/scottguymer.jpg"><meta name=generator content="Hugo 0.64.0"><link rel=canonical href=https://www.scottguymer.co.uk/post/blackduck-scanning-in-docker/><meta name=renderer content="webkit"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=format-detection content="telephone=no,email=no,adress=no"><meta http-equiv=cache-control content="no-transform"><meta name=robots content="index,follow"><meta name=referrer content="origin-when-cross-origin"><meta name=google-site-verification content="Rop88G3o4ZxIlfG_B3VHOKboh8LM_UpKZTB1d1CTbIE"><meta name=theme-color content="#02b875"><meta name=apple-mobile-web-app-capable content="yes"><meta name=apple-mobile-web-app-status-bar-style content="black"><meta name=apple-mobile-web-app-title content="Scott Guymer"><meta name=msapplication-tooltip content="Scott Guymer"><meta name=msapplication-navbutton-color content="#02b875"><meta name=msapplication-TileColor content="#02b875"><meta name=msapplication-TileImage content="/icons/icon-144x144.png"><link rel=icon href=https://www.scottguymer.co.uk/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://www.scottguymer.co.uk/icons/icon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://www.scottguymer.co.uk/icons/icon-32x32.png><link rel=icon sizes=192x192 href=https://www.scottguymer.co.uk/icons/icon-192x192.png><link rel=apple-touch-icon href=https://www.scottguymer.co.uk/icons/icon-152x152.png><link rel=manifest href=https://www.scottguymer.co.uk/manifest.json><link rel=preload href=https://www.scottguymer.co.uk/styles/main-rendered.min.css as=style><link rel=preload href="https://fonts.googleapis.com/css?family=Lobster" as=style><link rel=preload href=https://www.scottguymer.co.uk/images/scottguymer.jpg as=image><link rel=preload href=https://www.scottguymer.co.uk/images/grey-prism.svg as=image><style>body{background:#f4f3f1url(/images/grey-prism.svg)repeat fixed}</style><link rel=stylesheet href=https://www.scottguymer.co.uk/styles/main-rendered.min.css><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Lobster"><script src=https://cdn.jsdelivr.net/npm/medium-zoom@1.0.2/dist/medium-zoom.min.js></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/video.js@7.3.0/dist/video-js.min.css><!--[if lte IE 8]><script src=https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js></script><script src=https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js></script><script src=https://cdn.jsdelivr.net/npm/videojs-ie8@1.1.2/dist/videojs-ie8.min.js></script><![endif]--><!--[if lte IE 9]><script src=https://cdn.jsdelivr.net/npm/eligrey-classlist-js-polyfill@1.2.20180112/classList.min.js></script><![endif]--></head><body><div class=suspension><a role=button aria-label="Go to top" title="Go to top" class="to-top is-hide"><span class="icon icon-up" aria-hidden=true></span></a><a role=button aria-label="Go to comments" title="Go to comments" class=to-comment href=#disqus_thread><span class="icon icon-comment" aria-hidden=true></span></a></div><header class=site-header><a href=https://www.scottguymer.co.uk/><img class=avatar src=https://www.scottguymer.co.uk/images/scottguymer.jpg alt=Avatar></a><h2 class=title><a href=https://www.scottguymer.co.uk/>Scott Guymer</a></h2><p class=subtitle>~ Software Engineer ~</p><button class=menu-toggle type=button aria-label="Main Menu" aria-expanded=false tab-index=0>
<span class="icon icon-menu" aria-hidden=true></span></button><nav class="site-menu collapsed"><h2 class=offscreen>Main Menu</h2><ul class=menu-list><li class="menu-item
is-active"><a href=https://www.scottguymer.co.uk/>Home</a></li><li class=menu-item><a href=https://www.scottguymer.co.uk/tags/>Tags</a></li><li class=menu-item><a href=https://www.scottguymer.co.uk/about/>About</a></li></ul></nav><nav class="social-menu collapsed"><h2 class=offscreen>Social Networks</h2><ul class=social-list><li class=social-item><a href=mailto:blog@scottguymer.co.uk title=Email aria-label=Email><span class="icon icon-email" aria-hidden=true></span></a></li><li class=social-item><a href=//github.com/scottguymer rel=me title=GitHub aria-label=GitHub><span class="icon icon-github" aria-hidden=true></span></a></li><li class=social-item><a href=//twitter.com/mr_scottguymer rel=me title=Twitter aria-label=Twitter><span class="icon icon-twitter" aria-hidden=true></span></a></li><li class=social-item><a href=//www.linkedin.com/in/scottguymer rel=me title=LinkedIn aria-label=LinkedIn><span class="icon icon-linkedin" aria-hidden=true></span></a></li></ul></nav></header><section class="main post-detail"><header class=post-header><h1 class=post-title>BlackDuck Docker image scanning from within a docker container</h1><p class=post-meta>@Scott Guymer · May 18, 2020 · 4 min read</p></header><article class=post-content><p>Docker is a great tool for build pipelines, without a doubt it allows you to create isolated and reproducible builds. Not just of docker images themselves, but also for artifacts that you might extract and use outside of the container.</p><p>When you are building Docker images security should be one of the concerns you can take care of in your CI piplien. This varies from simple linting of your dockerfiles using something like <a href=https://github.com/hadolint/hadolint>hadolint</a> to a more complex scanner that can scan the internals of your images and give you some clues as to where you might need to address security concerns.</p><p>Within my current organisation we use a scanner called BlackDuck which among other things is able to scan both the source code of your application and any docker images.</p><p>In this post we will look at using BlackDuck to scan your completed docker images.</p><p>I ran into quite a few challenges in getting the BlackDuck scan to work as part of the CI pipeline. To add extra difficulty I wanted to run the scanner from within its own docker container. This is simply because the only dependency installed on the build server should be docker itself. You can achieve most tasks with this philosophy but when it comes to running other containers it can get quite complex.</p><p>Put simply we wanted to start a BlackDuck scanner container and pass it an image reference and have it run its scanner over the indicated image, save the results locally so that they can be uploaded to the BlackDuck server later.</p><p>In the end I ended up with this complex looking <code>docker run</code> command</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>docker run <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>  -d <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>  --network host <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>  -v ~/.docker/config.json:/root/.docker/config.json <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>  -v /var/run/docker.sock:/var/run/docker.sock <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>  -v /tmp/blackduck/inspectorshared/:/tmp/blackduck/inspectorshared/ <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>  my.private.registry/blackduckscanner:<span style=color:#e6db74>${</span>BLACKDUCK_DETECT_VERSION<span style=color:#e6db74>}</span> <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>    --detect.docker.passthrough.shared.dir.path.local<span style=color:#f92672>=</span>/tmp/blackduck/inspectorshared/ <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>    --detect.docker.passthrough.shared.dir.path.imageinspector<span style=color:#f92672>=</span>/tmp/blackduck/inspectorshared/ <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>    --detect.tools<span style=color:#f92672>=</span>DOCKER <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>    --detect.project.name<span style=color:#f92672>=</span><span style=color:#e6db74>${</span>SCAN_PROJECT_NAME<span style=color:#e6db74>}</span> <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>    --detect.project.version.name<span style=color:#f92672>=</span><span style=color:#e6db74>${</span>SCAN_PROJECT_VERSION<span style=color:#e6db74>}</span>_<span style=color:#e6db74>${</span>SCAN_PROJECT_GROUP<span style=color:#e6db74>}</span>_dockerImage <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>    --detect.code.location.name<span style=color:#f92672>=</span><span style=color:#e6db74>${</span>SCAN_PROJECT_NAME<span style=color:#e6db74>}</span>_<span style=color:#e6db74>${</span>SCAN_PROJECT_GROUP<span style=color:#e6db74>}</span>_<span style=color:#e6db74>${</span>SCAN_PROJECT_VERSION<span style=color:#e6db74>}</span>_<span style=color:#e6db74>${</span>SCAN_COMPONENT_NAME<span style=color:#e6db74>}</span>_dockerImage <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>    --detect.bom.aggregate.name<span style=color:#f92672>=</span><span style=color:#e6db74>${</span>SCAN_COMPONENT_NAME<span style=color:#e6db74>}</span> <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>    --blackduck.offline.mode<span style=color:#f92672>=</span>true <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>    --detect.docker.image<span style=color:#f92672>=</span><span style=color:#e6db74>${</span>IMAGE_PATH<span style=color:#e6db74>}</span>
</code></pre></div><p>There is a lot to unpack in the above command.</p><ul><li><p><code>-d</code> - run the image in the background rather than waiting
I did this so that we can simply return the UUID for the container and wait for it to complete. We can then use <code>docker cp</code> to copy the scan results out of the container. This gets around permission issues created when mounting a volume to the running container. These are usually due to the container user being root and the host not being able to modify/delete files created inside the container.</p></li><li><p><code>--network host</code> set the networking mode to host so that all ports are accessible on <code>localhost</code> in the container
We do this because the BlackDuck scanner starts up some other services that are used for scanning and by default it accesses them on localhost ports. This can be configured but this seems simpler.</p></li><li><p>We then mount the host <code>config.json</code> to provide credentials for private registries.
we assume that the host has already logged into the private registry that is used for the images we want to scan.</p></li><li><p><code>-v /var/run/docker.sock:/var/run/docker.sock</code> mount the docker.sock so that the container can start containers on the docker host it is running on.</p></li><li><p><code>-v /tmp/blackduck/inspectorshared/:/tmp/blackduck/inspectorshared/</code>
The Blackduck scanner uses mounted volumes to communicate with the other services that it starts. Its important that this volume is named the exact same inside the container and on the host.</p></li><li><p><code>my.private.registry/blackduckscanner:${BLACKDUCK_DETECT_VERSION}</code>
The BlackDuck scanner image that we want to run that will complete the scans</p></li><li><p><code>-detect.docker.passthrough.shared.dir.path.local=/tmp/blackduck/inspectorshared/</code></p></li><li><p><code>-detect.docker.passthrough.shared.dir.path.imageinspector=/tmp/blackduck/inspectorshared/</code>
These two properties work in conjunction with the volume mount above so that the volume is shared between the BlackDuck scanner container and the scanning services that the scanner starts as part of its operation. Its important that they match the volume defined above.</p></li><li><p><code>-detect.tools=DOCKER</code>
Tells the BlackDuck scanner to use the DOCKER tool, this is the tool used for scanning docker images.</p></li><li><p><code>-blackduck.offline.mode=true</code>
For our purposes we run the scanner in offline mode as we dont have direct access to the BlackDuck backend from our build environment.</p></li></ul><p>The following are all BlackDuck properties that are used to identify the scan results created by the scanner.</p><ul><li><code>-detect.project.name=${SCAN_PROJECT_NAME}</code></li><li><code>-detect.project.version.name=${SCAN_PROJECT_VERSION}_${SCAN_PROJECT_GROUP}_dockerImage</code></li><li><code>-detect.code.location.name=${SCAN_PROJECT_NAME}_${SCAN_PROJECT_GROUP}_${SCAN_PROJECT_VERSION}_${SCAN_COMPONENT_NAME}_dockerImage</code></li><li><code>-detect.bom.aggregate.name=${SCAN_COMPONENT_NAME}</code></li><li><code>-detect.docker.image=${IMAGE_PATH}</code></li></ul><h2 id=getting-the-results-our-of-the-image>Getting the results our of the image</h2><p>To bypass difficulties with mounting a volume to access the results directly we use a trick with <code>docker cp</code> to access the contents of the container after its completed its run</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>SCANNER_CONTAINER_UUID<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>docker run &lt;snip&gt;<span style=color:#66d9ef>)</span>
docker wait <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>SCANNER_CONTAINER_UUID<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>
docker cp <span style=color:#e6db74>&#34;</span>$SCANNER_CONTAINER_UUID<span style=color:#e6db74>:/root/blackduck</span><span style=color:#e6db74>&#34;</span> .
</code></pre></div></article><footer class=post-footer><ul class=post-tags><li><a href=https://www.scottguymer.co.uk/tags/build><span class=tag>Build</span></a></li><li><a href=https://www.scottguymer.co.uk/tags/containers><span class=tag>Containers</span></a></li><li><a href=https://www.scottguymer.co.uk/tags/security><span class=tag>Security</span></a></li><li><a href=https://www.scottguymer.co.uk/tags/docker><span class=tag>Docker</span></a></li></ul><p class=post-copyright>© This post is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License，please give source if you wish to quote or reproduce.</p></footer><div id=disqus_thread></div><script type=application/javascript>var disqus_config=function(){};(function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById('disqus_thread').innerHTML='Disqus comments not available by default when the website is previewed locally.';return;}
var d=document,s=d.createElement('script');s.async=true;s.src='//'+"scottguymer"+'.disqus.com/embed.js';s.setAttribute('data-timestamp',+new Date());(d.head||d.body).appendChild(s);})();</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></section><footer class=site-footer><p>© 2017-2020 Scott Guymer</p><p>Powered by <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> with theme <a href=https://github.com/laozhu/hugo-nuo target=_blank rel=noopener>Nuo</a>.</p></footer><script src=https://cdn.jsdelivr.net/npm/smooth-scroll@15.0.0/dist/smooth-scroll.min.js></script><script async src=https://cdn.jsdelivr.net/npm/video.js@7.3.0/dist/video.min.js></script><script async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><script type=text/x-mathjax-config>
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [['$','$'], ['\\(','\\)']],
      displayMath: [['$$','$$'], ['\\[','\\]']],
      processEscapes: true,
      processEnvironments: true,
      skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
      TeX: { equationNumbers: { autoNumber: "AMS" },
      extensions: ["AMSmath.js", "AMSsymbols.js"] }
    },
  });
</script><script type=text/x-mathjax-config>
  // Fix <code> tags after MathJax finishes running. This is a
  // hack to overcome a shortcoming of Markdown. Discussion at
  // https://github.com/mojombo/jekyll/issues/199
  MathJax.Hub.Queue(() => {
    MathJax.Hub.getAllJax().map(v => v.SourceElement().parentNode.className += ' has-jax');
  });
</script><script src=https://www.scottguymer.co.uk/scripts/index.min.js></script><script>if('serviceWorker'in navigator){navigator.serviceWorker.register('\/service-worker.js').then(function(){console.log('[ServiceWorker] Registered');});}</script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-113812052-1','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script></body></html>